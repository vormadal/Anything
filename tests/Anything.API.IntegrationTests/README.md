# Integration Tests

This directory contains integration tests for the Anything API.

## Prerequisites

- .NET 10 SDK
- Docker (for Testcontainers PostgreSQL)
- Kiota CLI tool

## Regenerating the API Client

The integration tests use a Kiota-generated API client located in `ApiClient/`. When new endpoints are added to the API, the client must be regenerated:

### Step 1: Install Kiota (if not already installed)

```bash
dotnet tool install --global Microsoft.OpenApi.Kiota
```

### Step 2: Start the API with a PostgreSQL Database

The API requires a running PostgreSQL instance. The easiest way is to use the Aspire AppHost:

```bash
cd ../../src/Anything.AppHost
dotnet run
```

Alternatively, start PostgreSQL manually and run the API standalone:

```bash
# Start PostgreSQL (example using Docker)
docker run -d --name postgres-dev -p 5432:5432 \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=anything_dev \
  postgres:17

# Run the API
cd ../../src/Anything.API
dotnet run
```

### Step 3: Generate Swagger JSON

Once the API is running, fetch the swagger specification:

```bash
curl http://localhost:5000/swagger/v1/swagger.json -o ../../swagger.json
```

### Step 4: Regenerate the Kiota Client

From the integration tests directory:

```bash
cd tests/Anything.API.IntegrationTests
kiota update
```

This will regenerate all client code in the `ApiClient/` directory based on the swagger specification.

### Step 5: Run the Tests

```bash
dotnet test
```

## Running Tests

Simply run:

```bash
dotnet test
```

The tests use Testcontainers to automatically spin up a PostgreSQL instance in Docker. No manual database setup is required.

## Test Structure

- `AuthEndpointTests.cs` - Tests for authentication endpoints (login, register, refresh)
- `SomethingEndpointTests.cs` - Tests for the Something entity CRUD operations
- `StorageUnitEndpointTests.cs` - Tests for the StorageUnit entity CRUD operations
- `BoxEndpointTests.cs` - Tests for the Box entity CRUD operations
- `ItemEndpointTests.cs` - Tests for the Item entity CRUD operations
- `Infrastructure/` - Test infrastructure (test base class, fixtures, API factory)
- `ApiClient/` - Auto-generated Kiota API client (do not manually edit)

## Notes

- The API client in `ApiClient/` is auto-generated by Kiota. Do not manually edit these files.
- After adding new endpoints to the API, always regenerate the client before running tests.
- Tests use an admin user (`admin@anything.local` / `Admin123!`) that is automatically seeded.
- Each test runs in isolation with database cleanup between tests via `ResetDatabaseAsync()`.
